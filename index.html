<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="">
<meta name="author" content="">
<title>iMapViewer</title>
<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/simple-sidebar.css">
<script src="js/jquery-3.3.1.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/plotly-latest.min.js"></script>
<!--script src="js/plotly-gl2d-latest.min.js"></script-->
<style>
  #map-warp {
  
  }
  #map-view {
    /*
    position: absolute;
    top: 0px;
    */
  }
  /*
  #map-warp svg {
    clip-path: circle(50% at center);
    -webkit-clip-path: circle(50% at center);
  }
  #map-view svg {
    clip-path: circle(50% at center);
    -webkit-clip-path: circle(50% at center);
  }
  */
  svg .heatmaplayer {
    clip-path: circle(50% at center);
    -webkit-clip-path: circle(50% at center);
  }
  div.map {
    float: left;
    -webkit-transition: 0.2s;
    transition: 0.2s;
    z-index: 0;
  }
  /*
  div.map:hover {
    transform: scale(2);
    z-index: 999;
  }
  */
  #menu-toggle {
    position: absolute;
    left: 0px;
    top: 50%;
    font-size: 10px;
    margin: 0px;
    padding: 0px;
    opacity: 0;
  }
  #menu-toggle:hover {
    opacity: 1;
  }
  .loader {
    border: 10px solid #f3f3f3;
    border-top: 10px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  } 
</style>
</head>

<body>

    <div id="wrapper">

        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <div id="map-view"></div>
            <h2 class="text-center">XXXX.XX</h2>
        </div>
        <!-- /#sidebar-wrapper -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
            
            <div class="container-fluid" style="padding:0px">
                <div id="map-warp"></div>
                <img id="jpg-export"></img>
                <a href="#menu-toggle" class="btn btn-secondary" id="menu-toggle">>></a>
            </div>
            
            <!--div class="loader text-center"></div-->
            
        </div>
        <!-- /#page-content-wrapper -->

    </div>
    <!-- /#wrapper -->

<script>
var d3 = Plotly.d3;
$(document).ready(function() {
    
    var img_jpg= d3.select('#jpg-export');
    
    var size = 30;
    var r = size / 2;
    var z = new Array(size);

    var start = performance.now();

    for(let i = 0; i < size; i++) {
        //z[i] = new Array(size);
        z[i] = new Float32Array(size);
    }

    for(let i = 0; i < size; i++) {
        for(let j = 0; j < size; j++) {
            ii = i - r;
            jj = j - r;
            if ((ii*ii + jj*jj) > r*r) {
                z[i][j] = NaN;
            } else {
                z[i][j] = i * j;
            }
        }
    }

    var end = performance.now();
    console.log((end - start) + " ms");
    
    var color_scale = [
        [0.0000, 'rgb(255,000,255)'],
        [0.1333, 'rgb(000,000,255)'],
        [0.3333, 'rgb(000,128,255)'],
        [0.5000, 'rgb(000,255,000)'],
        [0.6666, 'rgb(255,255,000)'],
        [0.8333, 'rgb(255,128,000)'],
        [1.0000, 'rgb(255,000,000)']
    ]
    
    var data = [{
        z: z,
        xaxis: 'x1',
        yaxis: 'y1',
        type: 'heatmap',
        showscale: false,
        connectgaps: true,
        zsmooth: 'best',
        xgap: 0,
        ygap: 0,
        colorscale: color_scale
    },{
        z: z,
        xaxis: 'x2',
        yaxis: 'y2',
        type: 'heatmap',
        showscale: false,
        connectgaps: true,
        zsmooth: 'best',
        xgap: 0,
        ygap: 0,
        colorscale: color_scale
    },{
        z: z,
        xaxis: 'x3',
        yaxis: 'y3',
        type: 'heatmap',
        showscale: false,
        connectgaps: true,
        zsmooth: 'best',
        xgap: 0,
        ygap: 0,
        colorscale: color_scale
    },{
        z: z,
        xaxis: 'x4',
        yaxis: 'y4',
        type: 'heatmap',
        showscale: false,
        connectgaps: true,
        zsmooth: 'best',
        xgap: 0,
        ygap: 0,
        colorscale: color_scale
    }];

    var layout = {
        width: 200,
        height: 200,
        margin: {
            l: 0, r: 0, t: 0, b: 0, pad: 0
        },
        rows: 2,
        columns: 10,
        xaxis: {
            domain: [0.5, 1],
            anchor: 'x1',
            showgrid: false,
            zeroline: false,
            showline: false,
            autotick: false,
            ticks: '',
            showticklabels: false
        },
        yaxis: {
            domain: [0, 0.5],
            anchor: 'y1',
            showgrid: false,
            zeroline: false,
            showline: false,
            autotick: false,
            ticks: '',
            showticklabels: false
        },
        xaxis2: {
            domain: [0.5, 1],
            anchor: 'x2',
            showgrid: false,
            zeroline: false,
            showline: false,
            autotick: false,
            ticks: '',
            showticklabels: false
        },
        yaxis2: {
            domain: [0.5, 1],
            anchor: 'y2',
            showgrid: false,
            zeroline: false,
            showline: false,
            autotick: false,
            ticks: '',
            showticklabels: false
        },
        xaxis3: {
            domain: [0, 0.5],
            anchor: 'x3',
            showgrid: false,
            zeroline: false,
            showline: false,
            autotick: false,
            ticks: '',
            showticklabels: false
        },
        yaxis3: {
            domain: [0, 0.5],
            anchor: 'y3',
            showgrid: false,
            zeroline: false,
            showline: false,
            autotick: false,
            ticks: '',
            showticklabels: false
        },
        xaxis4: {
            domain: [0, 0.5],
            anchor: 'x4',
            showgrid: false,
            zeroline: false,
            showline: false,
            autotick: false,
            ticks: '',
            showticklabels: false
        },
        yaxis4: {
            domain: [0.5, 1],
            anchor: 'y4',
            showgrid: false,
            zeroline: false,
            showline: false,
            autotick: false,
            ticks: '',
            showticklabels: false
        },
        /*
        shapes: [{
            type: 'circle',
            x0: -0.5,
            y0: -0.5,
            x1: 29.5,
            y1: 29.5,
            opacity: 1,
            fillcolor: 'none',
            line: {
                color: 'black',
                width: 0.5
            }
        }]
        */
    }

    var config = {
        displayModeBar: false,
        staticPlot: true,
        editable: true
    }

    var $warp_div = $('#map-warp');

    function syncPlot(i) {
        let innerDiv = document.createElement('div');
        innerDiv.id = 'myDiv' + (i+1);
        innerDiv.className = 'map';
        $warp_div.append(innerDiv);
        Plotly.react('myDiv' + (i+1), data, layout, config)
            .then(function(gd) {
                Plotly.toImage(gd,{height:300,width:300}).then(function(url) {
                    img_jpg.attr("src", url);
                    return Plotly.toImage(gd,{format:'jpeg',height:400,width:400});
                })
            }
        );
    }

    async function asyncPlot(i) {
        let innerDiv = document.createElement('div');
        innerDiv.id = 'myDiv' + (i+1);
        innerDiv.className = 'map';
        $warp_div.append(innerDiv);
        Plotly.react('myDiv' + (i+1), data, layout, config);
    }
    
    var start = performance.now();
    for(let i=0; i<1; i++) {
        //setTimeout(function() {
            //asyncPlot(i);
            syncPlot(i);
        //}, 1000);
    }
    var end = performance.now();
    console.log((end - start) + " ms");
    
    $('div.map').hover(function() {
        //$('map-view')
        layout['width'] = 300;
        layout['height'] = 300;
        Plotly.react('map-view', data, layout, {displayModeBar: false});
    });

    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
});
</script>
</body>
</html>